// ============================================
// DATABASE CONFIGURATION
// ============================================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")  //
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// USER MODEL
// ============================================
// Represents a person using the system
model User {
  id                    Int              @id @default(autoincrement())
  email                 String           @unique
  passwordHash          String
  firstName             String
  lastName              String
  avatar                String?
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  // Relations - IMPORTANT: Add opposite side for each relation
  memberships           Membership[]                        // User in many organizations
  tasks                 Task[]           @relation("TaskAssignee")  // Tasks assigned to user
  
  // NEW: User can own many organizations
  ownedOrganizations    Organization[]   @relation(name: "OrgOwner")
  
  // NEW: User can create many projects
  createdProjects       Project[]        @relation(name: "ProjectCreator")
  
  @@index([email])
}

// ============================================
// ORGANIZATION MODEL
// ============================================
// Represents a company/team
model Organization {
  id                    Int              @id @default(autoincrement())
  name                  String
  description           String?
  slug                  String           @unique
  
  // Who owns this organization?
  ownerId               Int
  owner                 User             @relation(name: "OrgOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  // Relations
  memberships           Membership[]
  projects              Project[]
  
  @@index([ownerId])
  @@index([slug])
}

// ============================================
// MEMBERSHIP MODEL (Multi-Tenancy Key)
// ============================================
// Represents "User X is in Organization Y with Role Z"
model Membership {
  id                    Int              @id @default(autoincrement())
  
  userId                Int
  organizationId        Int
  
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization          Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  role                  Role             @default(MEMBER)
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// ============================================
// ROLE ENUM
// ============================================
enum Role {
  OWNER
  ADMIN
  MEMBER
}

// ============================================
// PROJECT MODEL
// ============================================
// Represents a group of related tasks
model Project {
  id                    Int              @id @default(autoincrement())
  name                  String
  description           String?
  
  organizationId        Int
  organization          Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Who created it?
  createdBy             Int
  creator               User             @relation(name: "ProjectCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  
  status                ProjectStatus    @default(ACTIVE)
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  // Relations
  tasks                 Task[]
  
  @@index([organizationId])
  @@index([createdBy])
}

// ============================================
// PROJECT STATUS ENUM
// ============================================
enum ProjectStatus {
  ACTIVE
  ARCHIVED
}

// ============================================
// TASK MODEL
// ============================================
// Represents a single work item
model Task {
  id                    Int              @id @default(autoincrement())
  title                 String
  description           String?
  
  projectId             Int
  project               Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Who is this task assigned to?
  assignedTo            Int?
  assignee              User?            @relation(name: "TaskAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  
  status                TaskStatus       @default(BACKLOG)
  priority              TaskPriority     @default(MEDIUM)
  
  dueDate               DateTime?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([projectId])
  @@index([assignedTo])
  @@index([status])
}

// ============================================
// TASK STATUS ENUM
// ============================================
enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

// ============================================
// TASK PRIORITY ENUM
// ============================================
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}