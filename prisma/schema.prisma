// ============================================
// DATABASE CONFIGURATION
// ============================================
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// USER MODEL
// ============================================
model User {
  id                    Int              @id @default(autoincrement())
  email                 String           @unique
  passwordHash          String
  firstName             String
  lastName              String
  avatar                String?
  
  refreshTokenRecords RefreshTokenRecord[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  // Relations
  memberships           Membership[]                        // Org-level memberships
  projectMemberships    ProjectMembership[]                 // Project-level memberships
  tasks                 Task[]           @relation("TaskAssignee")
  ownedOrganizations    Organization[]   @relation(name: "OrgOwner")
  createdProjects       Project[]        @relation(name: "ProjectCreator")
  
  @@index([email])
  
}

// ============================================
// ORGANIZATION MODEL
// ============================================
model Organization {
  id                    Int              @id @default(autoincrement())
  name                  String
  description           String?
  slug                  String           @unique
  
  ownerId               Int
  owner                 User             @relation(name: "OrgOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  // Relations
  memberships           Membership[]
  projects              Project[]
  
  @@index([ownerId])
  @@index([slug])
}

// ============================================
// MEMBERSHIP MODEL (Organization-level)
// ============================================
// Represents "User X is in Organization Y with Role Z"
model Membership {
  id                    Int              @id @default(autoincrement())
  
  userId                Int
  organizationId        Int
  
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization          Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  role                  OrgRole          @default(MEMBER)
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// ============================================
// ORGANIZATION ROLE ENUM
// ============================================
enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

// ============================================
// PROJECT MODEL
// ============================================
model Project {
  id                    Int              @id @default(autoincrement())
  name                  String
  description           String?
  
  organizationId        Int
  organization          Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdBy             Int
  creator               User             @relation(name: "ProjectCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  
  status                ProjectStatus    @default(ACTIVE)
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  // Relations
  tasks                 Task[]
  projectMemberships    ProjectMembership[]  // NEW: Project-level memberships
  
  @@index([organizationId])
  @@index([createdBy])
}

// ============================================
// PROJECT STATUS ENUM
// ============================================
enum ProjectStatus {
  ACTIVE
  ARCHIVED
}

// ============================================
// PROJECT MEMBERSHIP MODEL (NEW)
// ============================================
// Represents "User X is in Project Y with Role Z"
// Only users with org membership can have project membership
model ProjectMembership {
  id                    Int              @id @default(autoincrement())
  
  userId                Int
  projectId             Int
  
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  project               Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  role                  ProjectRole      @default(MEMBER)
  
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}

// ============================================
// PROJECT ROLE ENUM (NEW)
// ============================================
enum ProjectRole {
  ADMIN       // Can manage project & team
  LEAD        // Can manage tasks & assign
  MEMBER      // Can view & edit own tasks
  VIEWER      // Read-only access
}

// ============================================
// TASK MODEL
// ============================================
model Task {
  id                    Int              @id @default(autoincrement())
  title                 String
  description           String?
  
  projectId             Int
  project               Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Task creator (for audit)
  createdBy             Int?
  
  // Who is this task assigned to? MUST be in project team
  assignedTo            Int?
  assignee              User?            @relation(name: "TaskAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  
  status                TaskStatus       @default(BACKLOG)
  priority              TaskPriority     @default(MEDIUM)
  
  dueDate               DateTime?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  
  @@index([projectId])
  @@index([assignedTo])
  @@index([status])
}

// ============================================
// TASK STATUS ENUM
// ============================================
enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

// ============================================
// TASK PRIORITY ENUM
// ============================================
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// Refresh Token
// ============================================

model RefreshTokenRecord {
  id        Int     @id @default(autoincrement())
  token     String  @unique
  userId    Int
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  expiresAt DateTime
  revokedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([token])
}